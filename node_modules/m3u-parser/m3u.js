var Promise = require('bluebird');

function parse (data) {
    if (Buffer.isBuffer(data))
        data = data.toString();
    else if (typeof data !== 'string')
        return Promise.reject(new TypeError('Data passed to the parser should be a string'));

    return new Promise(function (resolve, reject) {
        data = data.split('\n')
            .filter(function (str) {
                return str.length > 0;
            });

        if (data.shift().trim() !== '#EXTM3U')
            return reject(new Error('Passed data is not valid M3U playlist'));

        var buffer = [], isWaitingForLink = false, line;

        while ((line = data.shift())) {
            line = line.trim();

            if (isWaitingForLink) {
                buffer[buffer.length - 1].url = line;
                isWaitingForLink = false;
            } else if (line.slice(0, 7) === '#EXTINF') {

                var regexp = /^#EXTINF:(-?)(\d+)(.*)?,\s?(.*)$/;
                var result = regexp.exec(line);
                if (!result)
                    throw new Error('Invalid M3U format');
                
                var item = {};
                item.duration = result[1] + result[2];
                item.title = result[4];

                var tags = result[3];
                if (tags) {
                    var pattern = /\s?([a-zA-Z]+-[a-zA-Z]+)=("(.*?)")/g;
                    var match;
                    while ((match = pattern.exec(tags))) {
                        var tagName = match[1];
                        var tagValue = match[3];
                        if (!match[3]) continue;
                        item[tagName] = tagValue;

                    }
                }

                // buffer.push({
                //     title:    result[6].trim(),
                //     duration: +(result[1] + result[2].trim())
                // });
                buffer.push(item);

                isWaitingForLink = true;
            } else {
                throw new Error('Invalid data');
            }
        }

        resolve(buffer);
    });
}

module.exports.parse = parse;
